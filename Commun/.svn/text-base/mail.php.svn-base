<?php
function makeEntete($titre) {
	extract($GLOBALS);
	$subject = "$CFG_MAIL_SUJET : $titre";
	$messageMail=file_get_contents("../html/entete_mail.html");
	$messageMail=str_replace("--TITRE--", $titre,$messageMail);
	$messageMail=str_replace("--STYLE_CSS--",$CFG_URL."/style.css",$messageMail);

	return  $messageMail;
}

function makePied($isNewsletter=false) {
	extract($GLOBALS);
	$messageMail="";
	
	if ($isNewsletter) {
	  $module='newsletter';
	  $rubModule=return_rubriqueFromModule($module);
	  $idrub=$rubModule['rub_id'];
	  $unsubscribe=$CFG_URL;
	  $unsubscribe.="/";
	  $unsubscribe.=makeURL_GET(array("mod" => $module,"rub" => $idrub,"option" => ""),"idnews=". $isNewsletter);
	  $messageMail=file_get_contents("../html/pied_newsletter_mail.html");
	
	  $messageMail=str_replace("--UNSCRIBE--", $unsubscribe,$messageMail);
	}
	
	$messageMail.=file_get_contents("../html/pied_mail.html");
	$messageMail=str_replace("--NOM_SITE--", $CFG_NOM,$messageMail);
	$messageMail=str_replace("--ADR_SITE--", $CFG_URL,$messageMail);

	return  $messageMail;
}

/**
 * @param $actu
 */
function sendMail($to, $tabData, $pageHtml, $isNewsletter=false) {
    extract($GLOBALS);
	$erreur="";
	$messageMail=makeEntete($tabData['--SUJET--']);

	$messageMail.=file_get_contents("../html/$pageHtml");
	
	foreach ($tabData as $key => $val) {
	  $messageMail=str_replace($key, $val,$messageMail);
	}

	$messageMail.=makePied($isNewsletter);

	/* Pour envoyer un mail au format HTML, vous pouvez configurer le type Content-type. */
	$headers  = "MIME-Version: 1.0\r\n";
	$headers .= "Content-type: text/html; charset=iso-8859-1\r\n";

	/* D'autres en-ttes */
	//$headers .= "To: marc.garces@tele2.fr\r\n";
	$headers .= "To: ".$to."\r\n";
	$headers .= "From: no-reply-".$CFG_MAIL_WEBMASTER."\r\n";

	//echo "mail(".$to.", ".$tabData['--SUJET--'].", ".$messageMail.",". $headers.")";

	/* et hop,  la poste */
	if (!mail($to, $tabData['--SUJET--'], $messageMail, $headers)) {
		$erreur = "Pb sur mail pour : ".$to;
	}
	return $erreur;
}

?>