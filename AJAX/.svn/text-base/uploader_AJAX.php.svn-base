<?php
$module="uploader";
function cmpUploader($a , $b) {
  //if ($a['type'] == "dir") return -1;
  $retour=strcmp($a['type'],$b['type']);
  if ($retour == 0) {
    if ($b['value'] == utf8Encode("Dossier prcdent")) {
      $retour = -1;
    }
    else {
      $retour=strcmp($a['value'],$b['value']);
    }
  }
  return $retour;
}

function pressePapier() { 
	$repLu="../userfiles/tmp";
	$tabFile = searchFiles($repLu,"");
	if ($tabFile && sizeof($tabFile) > 0) {
		return $tabFile[0];
	}
	else {
		return null;
	}
}

function searchFilesAjax($rep="") {

  $exclu=array('modules','presentation','tmp');

  $fileExclu=array('index.html');

  $notSup=array('Images','file','Images/Site','Images/Site/Icones','Images/Partenaires','Images/Diaporama');

  $suprep=1;

  if (($rep=="userfiles") || ($rep=="/") || ($rep==".")) $rep="";
  $repLu="../userfiles/$rep";
  $tabResult=array();
  $tabResult['home']="userfiles/";

  $tabResult["."]["type"]="dir";
  $tabResult["."]["value"]=$rep;
  $tabResult["."]["sup"]=0;
  if ($rep) {
    $tabResult[utf8Encode("Dossier prcdent")]["type"]="dir";
    $tabResult[utf8Encode("Dossier prcdent")]["value"]=dirname($rep) == "." ? "" : dirname($rep);
    $tabResult[utf8Encode("Dossier prcdent")]["sup"]=0;
  }
  foreach (searchFiles($repLu,"") as $key => $file) {
  	
  	//$file=utf8Encode($file);
  	
    if (!in_array ($file, $exclu)) {
      $filePath=$repLu."/".$file;
      $tabStat=stat($filePath);
      if (is_dir($filePath)) {
        $tabResult[$file]["type"]="dir";
        $path=$rep ? $rep."/" : "";
        $tabResult[$file]["value"]=$path.$file;
        $sup=$suprep;
        foreach ($notSup as $valnotSup) {
          //echo $path.$file;
          if ($valnotSup == $path.$file) {
            $sup=0;
            break;
          }
        }
        $tabResult[$file]["sup"]=$sup;
      }
      else {
        if (!in_array ($file, $fileExclu)) {
          $tabResult[$file]['size']=$tabStat['size'];
          $pathInfo = pathinfo($file);
          if (array_key_exists("extension",$pathInfo)) {
            $ext=strtolower($pathInfo['extension']);
            if ($ext =="png" || $ext =="jpg" ||$ext =="jpeg" ||$ext =="gif") {
              if (list($width, $height, $type, $attr) = getimagesize($repLu."/".$file)) {
                $tabResult[$file]["plus"]=$width."x".$height;
                $tabResult[$file]["height"]=$height;
                $tabResult[$file]["width"]=$width;
              }
            }
          }
          $tabResult[$file]["type"]=$ext;
          $tabResult[$file]["sup"]=1;
        }

      }
    }
  }
  uasort($tabResult, "cmpUploader");
  //ksort($tabResult,SORT_STRING );
  //print_r($tabResult);
  return $tabResult;
}
?>