<?php

$module="photos";
include_once "../Functions/".$module."_functions.php";
extractXMLToArray("../config/photos_config.xml","photos");
extractXMLToArray("../config/partenaires_config.xml","partenaires");

/**************************************/
/**************************************/
/* PHOTOS */
/**************************************/
/**************************************/

/*
 * recherche d'un photo aleatoire
 */
function return_photo_aleatoire($photosDir,$type="miniature",$recur="R") {
  global $photos_THUMBS_DIR;
  global $photos_IMAGE_STDDIM;
  global $CFG_URL;
  $listFile=array();
  $nbImages=0;

  if ($type == "miniature") {
    $type=$photos_THUMBS_DIR;
  }

  searchImages("../".$photosDir,$listFile,$type,$recur);

  $nbImages=sizeof($listFile);
  if ($nbImages > 0) {
    $numImage = rand(0, $nbImages-1);
    $tab['image'] = $listFile[$numImage];
    $tab['imageBig'] = 	str_replace($type,$photos_IMAGE_STDDIM, $tab['image']);
    $tab['imageBig'] = 	str_replace("__","", $tab['imageBig']);
    $tab['imageBig'] = 	str_replace("../","", $tab['imageBig']);
    $tab['image'] = 	str_replace("../","", $tab['image']);

    //$tab['image']=$CFG_URL."/".dirname($tab['image'])."/".$photos_THUMBS_DIR."/".basename($tab['image']);
    //$tab['imageBig']=$CFG_URL."/".dirname($tab['image'])."/".$photos_IMAGE_STDDIM."/".basename($tab['image']);
    $tab['image']=$CFG_URL."/".$tab['image'];
    $tab['imageBig']=$CFG_URL."/".$tab['imageBig'];
  }
  else {
    $tab['image'] = "";
    $tab['imageBig'] = "";
  }

  return $tab;
}

function return_photos($photosDir) {
  global $photos_THUMBS_DIR;
  global $photo_IMAGE_STDDIM;
  global $CFG_URL;
  $listFile=array();
  $nbImages=0;

  searchImages("../".$photosDir,$listFile,$photos_THUMBS_DIR);

  $nbImages=sizeof($listFile);
  if ($nbImages > 1) {
    $numImage = rand(0, $nbImages-1);
    //print_r(pathinfo($listFile[$numImage]));
    $tab['image'] = $listFile[$numImage];
    $tab['image'] = str_replace("../","", $tab['image']);
    $tab['image']=$CFG_URL."/".$tab['image'];
  }
  else {
    $tab['image'] = "";
  }

  return $tab;
}

function return_diaporama($photosDir,$nbMiniature, $heightDiapo,$index=0) {
  global $CFG_URL;
  global $CFG_NOM;
  global $CFG_REP_IMAGE_SITE;
  global $CFG_ICON_SITE;
  global $photos_GLOBAL_JPG_QUALITY;
  global $_SERVER;
  $listFile=array();
  $nbImages=0;
  $milieu=0;

  searchImages("../".$photosDir,$listFile,"","R");

  $nbImages=sizeof($listFile);
  if ($nbImages > 1) {

    if ($index > ($nbImages-1) ) {
      $index=0;
    }
    if ($nbMiniature > 0) {
      $milieu=($nbMiniature+1) /2;
    }
    $maxDebut=$nbImages-$nbMiniature;
    //echo "milieu :$milieu";
    $debutIndex=0;
    if ($index >= $milieu) {
      $debutIndex=($index-$milieu)+1;
      $indexSel=$milieu-1;
    }
    else {
      $indexSel=$index;
    }
    if ($debutIndex >= $maxDebut) {
      $debutIndex = $maxDebut;
      $indexSel=$index - $maxDebut;
    }

    $minFin=$nbMiniature;
    //	echo "milieu :$milieu";
    $finIndex=0;
    if ($index >= $milieu) {
      $finIndex=($index+$milieu)-1;
    }
    else {
      $finIndex=$minFin-1;
    }
    if (($finIndex+1) >= $nbImages) {
      $finIndex = $nbImages-1;
    }

    //echo "debutIndex = $debutIndex";
    //echo "finIndex = $finIndex";
    //echo "index = $index";

    //print_r(pathinfo($listFile[$numImage]));
    if (!is_dir("../tmp")) {
      mkdir("../tmp");
    }
    $filename = $listFile[$index];
    $tab['image']="../tmp/diapo_".$_SERVER['REMOTE_ADDR'].date('Ymdhis').".png";
    $mask = "../tmp/diapo_".$_SERVER['REMOTE_ADDR']."*.png";
    array_map( "unlink", glob( $mask ) );

    //echo $tab['image'];
    // Fichier et nouvelle taille

    // Calcul des nouvelles dimensions
    list($width, $height, $type, $attr) = getimagesize($filename);

    $ratio_orig = $width/$height;
    $newwidth = $heightDiapo;
    $newheight = $heightDiapo;

    if ($newwidth/$newheight> $ratio_orig) {
   			$newwidth = $newheight*$ratio_orig;
    } else {
   			$newheight = $newwidth/$ratio_orig;
    }


    // Chargement
    $thumb = imagecreatetruecolor($newwidth, $newheight);
    if ($type == 1) {
      $source = imagecreatefromgif($listFile[$index]);
    }
    if ($type == 2) {
      $source = imagecreatefromjpeg($listFile[$index]);
    }
    if ($type == 3) {
      $source = imagecreatefrompng($listFile[$index]);
    }
    imagealphablending($thumb, false); // setting alpha blending on

    // image du logo
    //$copy = @imagecreatefromgif($CFG_ICON_SITE);
    $imgFili = "../".CFG_REP_IMAGE_SITE."/Icones/".$CFG_ICON_SITE;
    list($width1, $height1, $type1, $attr1) = getimagesize($imgFili);
    if ($type1 == 1) {
      $copy  = imagecreatefromgif($imgFili);
    }
    if ($type1 == 2) {
      $copy  = imagecreatefromjpeg($imgFili);
    }
    if ($type1 == 3) {
      $copy  = imagecreatefrompng($imgFili);
    }
    $larg_cop=@imagesx($copy);
    $long_cop=@imagesy($copy);

    $x=($newwidth-$larg_cop)/2; // abscisses
    $y=($newheight-$long_cop)/2; //Ordonnés
    $x2=($newwidth-$larg_cop); // abscisses
    $y2=($newheight-$long_cop); //Ordonnés
    
    $police = "arial.ttf";
    $white = imagecolorallocate($im, 255, 255, 255);
    //imagettftext($thumb,$newwidth,45,0,$newheight,$white, $police, "toto");
    // Redimensionnement
    imagecopyresized($thumb, $source, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
    
    imagesavealpha($thumb, true); // save alphablending setting (important)
    
    //imagecopymerge($thumb,$copy, 0,0,0, 0, $larg_cop, $long_cop, 20);
    //imagecopymerge($thumb,$copy, $x, $y, 0, 0, $larg_cop, $long_cop, 20);
    //imagecopymerge($thumb,$copy, $x2, $y2, 0, 0, $larg_cop, $long_cop, 20);
    
    imagepng($thumb,$tab['image'], 9);
    
   //print_r(error_get_last());

    $tab['image']= str_replace("../","", $tab['image']);
    $tab['image']=$CFG_URL."/".$tab['image'];


    $tab['indexSel']=$indexSel;
    $tab['index']=$index;

    //print_r($listFile);
    $indexRetour=0;
    for ($j=$debutIndex;$j<=$finIndex;$j++) {
      //echo "recherche de $j";
      $imgTmp=str_replace("../","",  $listFile[$j]);
      $tab['images'][$indexRetour++]=$CFG_URL."/".$imgTmp;
    }
  }
  else {
    $tab['image'] = "";
  }

  return $tab;
}

function return_partenaires($photosDir,$partenaires_WIDTH, $partenaires_HEIGHT, $index=0,$ou="") {
  global $CFG_URL;
  global $photos_GLOBAL_JPG_QUALITY;
  global $_SERVER;
  $listFile=array();
  $nbImages=0;
  $milieu=0;

  searchImages("../".$photosDir,$listFile,"","S");

  $nbImages=sizeof($listFile);
  if ($nbImages > 1) {

    if ($index > ($nbImages-1) ) {
      $index=0;
    }

    //echo "debutIndex = $debutIndex";
    //echo "finIndex = $finIndex";
    //echo "index = $index";

    //print_r(pathinfo($listFile[$numImage]));
    if (!is_dir("../tmp")) {
      mkdir("../tmp");
    }
    $filename = $listFile[$index];
    $tab['image']="../tmp/partenaire_$ou".$_SERVER['REMOTE_ADDR'].date('Ymdhis').".png";
    $mask = "../tmp/partenaire_$ou".$_SERVER['REMOTE_ADDR']."*.png";
    array_map( "unlink", glob( $mask ) );

    //echo $tab['image'];
    // Fichier et nouvelle taille

    // 		Calcul des nouvelles dimensions
    list($width, $height, $type, $attr) = getimagesize($filename);

    $ratio_orig = $width/$height;
    $newwidth = $partenaires_WIDTH;
    $newheight = $partenaires_HEIGHT;

    // Chargement
    $thumb = imagecreatetruecolor($newwidth, $newheight);
    if ($type == 1) {
      $source = imagecreatefromgif($listFile[$index]);
    }
    if ($type == 2) {
      $source = imagecreatefromjpeg($listFile[$index]);
    }
    if ($type == 3) {
      $source = imagecreatefrompng($listFile[$index]);
    }
    imagealphablending($thumb, false); // setting alpha blending on

    // Redimensionnement
    imagecopyresized($thumb, $source, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);
    imagesavealpha($thumb, true); // save alphablending setting (important)
    imagepng($thumb,$tab['image'], 9);

    $tab['image']= str_replace("../","", $tab['image']);
    $tab['image']=$CFG_URL."/".$tab['image'];


    $tab['index']=$index++;

  }
  else {
    $tab['image'] = "";
  }

  return $tab;
}

function return_renameImageTitleUrl($imageBase,$widthNew, $heightNew,$title, $url, $plusName) {
  global $CFG_URL;
  global $photos_GLOBAL_JPG_QUALITY;
  global $_SERVER;
  $milieu=0;

  if (!is_dir("../tmp")) {
    mkdir("../tmp");
  }
  $filename = $imageBase;
  $tab['image']="../tmp/$plusName".$_SERVER['REMOTE_ADDR'].date('Ymdhis').".png";
  $mask = "../tmp/$plusName".$_SERVER['REMOTE_ADDR']."*.png";
  array_map( "unlink", glob( $mask ) );

  // 	Calcul des nouvelles dimensions
  
  list($width, $height, $type, $attr) = getimagesize($filename);
  //print_r(error_get_last());
  $ratio_orig = $width/$height;
  $newwidth = $widthNew;
  $newheight = $heightNew;

  // Chargement
  $thumb = imagecreatetruecolor($newwidth, $newheight);
  if ($type == 1) {
    $source = imagecreatefromgif($imageBase);
  }
  if ($type == 2) {
    $source = imagecreatefromjpeg($imageBase);
  }
  if ($type == 3) {
    $source = imagecreatefrompng($imageBase);
  }
  //imagealphablending($thumb, false); // setting alpha blending on
  //  On rend l'arrière-plan transparent
  //imagesavealpha($thumb, true);
  $black = imagecolorallocate($thumb, 0, 0, 0);

  // Make the background transparent
  imagecolortransparent($thumb, $black);

  // Redimensionnement
  imagecopyresized($thumb, $source, 0, 0, 0, 0, $newwidth, $newheight, $width, $height);

  if (!$type) {
    // grey
    $textcolor = imagecolorallocate($thumb, 1,1,1);
    //Ajout de la phrase en haut à gauche
    imagestring($thumb,5, 0, $newheight/2, $title , $textcolor);
  }

  imagepng($thumb,$tab['image'], 9);

  $tab['image']= str_replace("../","", $tab['image']);
  $tab['image']=$CFG_URL."/".$tab['image'];
  $tab['texte']=$title;
  if ($url) {
    $tab['url']=$url;
  }
  else {
    $tab['url']="#";
  }

  return $tab;
}

function return_presence_photo($photosDir) {
  global $photos_THUMBS_DIR;
  global $photo_IMAGE_STDDIM;
  $listFile=array();
  $nbImages=0;

  searchImages("../".$photosDir, $listFile,"");
  $nbImages=sizeof($listFile);

  return array(basename($photosDir),$nbImages);
}

// retourne les commentaires d'une photo
function return_commentaire_photo_ajax($url) {
  $tabTmp= return_commentaire_photo($url);

  foreach ($tabTmp as $key => $val) {
    $tabTmp[$key]['com_texte']=utf8Encode($val['com_texte']);
    $tabTmp[$key]['usr_nom']=utf8Encode($val['usr_nom']);
    $tabTmp[$key]['com_date']=utf8Encode(formateDateMYSQLtoFR($val['com_date']));
  }
  
  return $tabTmp;
}

// ajout un commentaire a une photo
function action_insert_commentaire($url, $user,$texte) {
  insert_commentaire($url, $user,$texte);
}

function return_commentairePhotoForUser_ajax($photo, $rub, $idUser) {
  $tab = return_commentairePhotoForUser($photo, $rub, $idUser);
  foreach ($tab as $key => $val) {
    $tab[$key]['com_texte']=utf8Encode($val['com_texte']);
    $tab[$key]['usr_nom']=utf8Encode($val['usr_nom']);
    $tab[$key]['com_date']=utf8Encode(formateDateMYSQLtoFR($val['com_date']));
  }
  
  //print_r($tab);
  return $tab;
}

function action_supCommentaire($id) {
  delete_commentaire($id);
}

/**
 * mise en place du nom de l'image de courverture
 * @param unknown_type $couverture
 * @param unknown_type $album
 */
function modifCheckCouverture($couverture, $album) {
  //echo "écriture de $album/.couverture";
  if ($couverture=="") {
    if (file_exists("../".$album."/.couverture")) {
      unlink("../".$album."/.couverture");
    }
  }
  else {
    file_put_contents("../".$album."/.couverture",$couverture);
  }
  //print_r(error_get_last());
}

function getImageCouverture($album) {
  return return_imageAlbum($album);
}
?>