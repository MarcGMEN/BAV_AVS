<?php

/***************USER ***************************/
/***************USER ***************************/
/***************USER ***************************/
/***************USER ***************************/
/*
 * retourne un user pour un id
 */
function return_user($id) {
  $row=null;
  if (isset($id) && strlen($id) > 0 ) {
    $requete = "select ".CFG_PREFIXE_TABLE."user.*,  tym1.*, tym2.tym_libelle tym2_libelle ";
    $requete .= " from ".CFG_PREFIXE_TABLE."user LEFT OUTER JOIN ".CFG_PREFIXE_TABLE."type_membre AS tym2 ON usr_id_tym_demande =  tym2.tym_id ";
    $requete .= " , ".CFG_PREFIXE_TABLE."type_membre as tym1 ";
    $requete .= " where usr_id = ".$id;
    $requete .= " and usr_id_tym = tym1.tym_id ";
    if (!$resultat = mysql_query($requete) ) {
      echo "erreur sur $requete ".mysql_error()."<br/>";
    }
    else { 
      $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
    }
  }
  return  $row;
}

/*
 * retourne un user pour un login
 */
function return_userByLogin($login) {
  $row=null;
  if (isset($login) && strlen($login) > 0 ) {
    $requete = "select ".CFG_PREFIXE_TABLE."user.*,  tym1.*, tym2.tym_libelle tym2_libelle ";
    $requete .= " from ".CFG_PREFIXE_TABLE."user LEFT OUTER JOIN ".CFG_PREFIXE_TABLE."type_membre AS tym2 ON usr_id_tym_demande =  tym2.tym_id ";
    $requete .= " , ".CFG_PREFIXE_TABLE."type_membre as tym1 ";
    $requete .= " where usr_login = '".$login."'";
    $requete .= " and usr_id_tym = tym1.tym_id ";
    if (!$resultat = mysql_query($requete) ) {
      echo "erreur sur $requete ".mysql_error()."<br/>";
    }
    else { 
      $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
    }
  }
  return  $row;
}

/*
 * retourne un user pour un login
 */
function return_userByLoginPass($login, $pass) {
  $row=null;
  if (isset($login) && strlen($login) > 0 ) {
    $requete = "select ".CFG_PREFIXE_TABLE."user.*,  tym1.*, tym2.tym_libelle tym2_libelle ";
    $requete .= " from ".CFG_PREFIXE_TABLE."user LEFT OUTER JOIN ".CFG_PREFIXE_TABLE."type_membre AS tym2 ON usr_id_tym_demande =  tym2.tym_id ";
    $requete .= " , ".CFG_PREFIXE_TABLE."type_membre as tym1 ";
    $requete .= " where usr_login = '".$login."'";
    $requete .= " and usr_pass = '".$pass."'";
    $requete .= " and usr_id_tym = tym1.tym_id ";
    if (!$resultat = mysql_query($requete) ) {
      echo "erreur sur $requete ".mysql_error()."<br/>";
    }
    else { 
      $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
    }
  }
  return  $row;
}
/*
 * retourne un user pour un login
 */
function return_userByMail($mail) {
  $row=null;
  if (isset($mail) && strlen($mail) > 0 ) {
    $requete = "select ".CFG_PREFIXE_TABLE."user.*,  tym1.*, tym2.tym_libelle tym2_libelle ";
    $requete .= " from ".CFG_PREFIXE_TABLE."user LEFT OUTER JOIN ".CFG_PREFIXE_TABLE."type_membre AS tym2 ON usr_id_tym_demande =  tym2.tym_id ";
    $requete .= " , ".CFG_PREFIXE_TABLE."type_membre as tym1 ";
    $requete .= " where usr_email = '".$mail."'";
    $requete .= " and usr_id_tym = tym1.tym_id ";
    if (!$resultat = mysql_query($requete) ) {
      echo "erreur sur $requete ".mysql_error()."<br/>";
    }
    else { 
      $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
    }
  }
  return  $row;
}

/*
 * retourne un user pour un ticket
 */
function return_userByTicket($ticket) {
  $row=null;
  if (isset($ticket) && strlen($ticket) > 0 ) {
    $requete = "select ".CFG_PREFIXE_TABLE."user.* ";
    $requete .= " from ".CFG_PREFIXE_TABLE."user ";
    $requete .= " where usr_ticket = '".$ticket."'";
    if (!$resultat = mysql_query($requete) ) {
      echo "erreur sur $requete ".mysql_error()."<br/>";
    }
    else { 
      $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
    }
  }
  return  $row;
}

/*
 * retourne un user pour un id
 */
function return_Alluser() {
  $requete = "select * ,  ".CFG_PREFIXE_TABLE."type_membre.* from ".CFG_PREFIXE_TABLE."user, ".CFG_PREFIXE_TABLE."type_membre ";
  $requete .= " where usr_id_tym = tym_id ";
  $requete .= " order by usr_nom";
  $resultat = mysql_query($requete);

  $i=0;
  while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
    $tabReturn[$row['usr_id']] = $row;
  }

  return  $tabReturn;
}

/*
 * retourne un user pour un id
 */
function return_user_rubrique($id) {
  $tabReturn=array();
  if ($id) {
    $requete = "select * from ".CFG_PREFIXE_TABLE."user_rubrique ";
    $requete .= " where urb_id_user = ".$id;
    //		echo $requete;
    $resultat = mysql_query($requete);
    $i=0;
    while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
      $tabReturn[$row['urb_id_rub']] = $row;
    }
  }

  return  $tabReturn;
}

/*******************TYPE_MEMBRE *************************/
/*******************TYPE_MEMBRE *************************/
/*******************TYPE_MEMBRE *************************/
/*******************TYPE_MEMBRE *************************/
/*******************TYPE_MEMBRE *************************/
function return_tymVisiteur() {
  $row=array();
  $requete = "select * from ".CFG_PREFIXE_TABLE."type_membre where tym_libelle = 'Visiteur'";
  $resultat = mysql_query($requete);
  $row = mysql_fetch_array($resultat, MYSQL_ASSOC);
  return  $row;
}

/*
 * retour de la liste des type de membre
 * format du tableau de retour tab['rub_id'] = tous les champs de la table
 */
function return_types_membre() {
  $tabReturn=array();
  $requete = "select * from ".CFG_PREFIXE_TABLE."type_membre ";
  $requete .= " order by tym_niveau ";
  $resultat = mysql_query($requete);
  $i=0;
  while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
    $tabReturn[$row['tym_id']] = $row;
  }

  return $tabReturn ;
}

/*
 * retour de la liste des type de membre
 * format du tableau de retour tab['rub_id'] = tous les champs de la table
 */
function return_type_membre($id) {
  $row=array();
  $requete = "select * from ".CFG_PREFIXE_TABLE."type_membre ";
  $requete .= " where tym_id = ".$id;
  $resultat = mysql_query($requete);
  $i=0;
  if ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
    return $row;
  }

  return $row;
}

/**
 * retourne les droits en lecture de la rubrique
 * si cette rubrique et affecté a un bloc, on verifie si l'option est modif des droits
 * en modif de cette rubrique
 * @param unknown_type $rub
 * @param unknown_type $user
 * @return unknown_type
 */
function droitRubriqueLecture($rub, $user) {
  if ($user['tym_niveau'] <= $rub['tym_niveau_lecture']) {
    if (isset($rub['tyb_option']) && strlen(trim($rub['tyb_option'])) > 0) {
      if (preg_match("[modif]",$rub['tyb_option']) >0 ) {
        if ($user['tym_niveau'] <= $rub['tym_niveau_modif']) {
          return true;
        }
        else {
          return false;
        }
      }
      else {
        return true;
      }
    }
    else {
      return true;
    }
  }
  else {
    return false;
  }
}

function droitRubriqueModif($rub, $user) {
    if ($user['tym_niveau'] <= $rub['tym_niveau_modif']) {
//    echo "OK sur niveau ".$user['tym_niveau']." <= ". $rub['tym_niveau_modif'];
    if (isset($user['usr_id'])) {
      $tabUrb=return_user_rubrique($user['usr_id']);
      if ($rub['rub_media'] == "oui") {
        if (isset($tabUrb[$rub['rub_id']]) && $tabUrb[$rub['rub_id']]['urb_droit'] == "O") {
      //    echo "OK pour media ";
          return true;
        }
        else {
  //        echo "media false";
          return false;
        }
      }
      else {
    //    echo "OK pour car pas media";
        return true;
      }
    }
    else {
      // recherche que par niveau
      //echo "no user media false";
      return true;
    }
  }
  else {
    return false;
  }
}

/**
 * droit de mise a jour ou de suppression sur un media present
 * @param : la rubrique
 * @param : le user actuel
 * @param : la reference de l'id user sur le media 0 = acces au media même si pas proprietaire
 */
function droitUDMedia($rub, $leUser, $id_usr_Object=0) {
  global $membre_NIVEAU_MODIF_RUBRIQUE;
  $retour=false;
  //echo "droitUDMedia false";
        
  if (droitRubriqueModif($rub, $leUser)) {
    if ($leUser['tym_niveau'] > $membre_NIVEAU_MODIF_RUBRIQUE) {
      if ($leUser['usr_id'] ==  $id_usr_Object) {
      //  echo "droitUDMedia true";
        $retour=true;
      }
      else if ($id_usr_Object==0) {
        //echo "droitUDMedia true";
        $retour=true;
      }
      else {
        //echo "droitUDMedia false";
        $retour=false;
      }
    }
    else {
      //echo "droitUDMedia true";
      $retour=true;
    }
  }
  return $retour;
}