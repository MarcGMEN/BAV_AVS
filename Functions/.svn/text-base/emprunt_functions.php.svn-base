<?php
include_once 'Functions/ouvrage_functions.php';

function return_emprunts($ouv, $tyo) {
	$tab=array();
	$requete = "select ".CFG_PREFIXE_TABLE."ouvrage_emprunt.*";
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage_emprunt ";
	$requete .= " where oem_id_ouv = $ouv ";
	$requete .= " and oem_id_tyo = $tyo ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		$index=0;
		while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
			$tab[$index++]=$row;
		}
	}

	return $tab;
}

function return_lastEmprunts($ouv, $tyo) {
	$row =null;
	$requete = "select ".CFG_PREFIXE_TABLE."ouvrage_emprunt.*";
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage_emprunt ";
	$requete .= " where oem_id_ouv = $ouv ";
	$requete .= " and oem_id_tyo = $tyo ";
	$requete .= " order by oem_date_debut desc ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		$row = mysql_fetch_array($resultat, MYSQL_ASSOC);
	}

	return $row;
}

function return_empruntsEnCours($tyo, $oep) {
	$tab=array();
	$requete = "select * " ;
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage_emprunt ";
	$requete .= " where oem_id_tyo = $tyo ";
	$requete .= " and oem_id_oep = $oep ";
	$requete .= " and oem_date_fin is null ";
	$requete .= " order by oem_date_debut ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		$index=0;
		while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
			$row2=return_ouvrage($row['oem_id_ouv'],$tyo);
			$tab[$index++]=array_merge($row, $row2);
		}
	}

	return $tab;
}

function return_achatsEnCours($tyo, $oep) {
	
	$d1=$dateMYSQL=date("Y-m-d H:i:s", mktime(date('H'),date('i'),date('m'),date(''),date('d'),date('Y')-1));
	$d2=$dateMYSQL=date("Y-m-d H:i:s");
	$tabCso = return_AllChampsOuvrage($tyo);
	$tab=array();
	$requete = "select * " ;
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage_emprunt ";
	$requete .= " where oem_id_tyo = $tyo ";
	$requete .= " and oem_id_oep = $oep ";
	$requete .= " and oem_date_debut between '$d1' and '$d2' ";
	$requete .= " order by oem_date_debut ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		$index=0;
		while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
			$row2=return_ouvrage($row['oem_id_ouv'],$tyo);
			foreach ($tabCso as $key => $val) {
				echo $row2['cho_valeur_libelle['.$val['cso_id'].']'];
				if (is_numeric($row2['cho_valeur_libelle['.$val['cso_id'].']'])) {
					$row['cho_valeur_total['.$val['cso_id'].']']=$row2['cho_valeur_libelle['.$val['cso_id'].']']*$row['oem_nb'];
				}
			}
			$tab[$index++]=array_merge($row, $row2);
		}
	}

	return $tab;
}

/*
 * recherche des ouvrages encore achetable.
 * Enter description here ...
 */
function return_achatsPossible($tyo) {
	$tabOuvrage=array();
	$requete = "select * ";
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage, ".CFG_PREFIXE_TABLE."ouvrage_classement ";
	$requete .= " where ouv_id_tyo = $tyo ";
	$requete .= " and ouv_id_sto = sto_id ";
	$requete .= " and ouv_nb_exemplaire_achete < ouv_nb_exemplaire  ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		$index=0;
		while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
			$row=array_merge($row,return_champDeLOuvrage($row['ouv_id'],$row['ouv_id_tyo']));
			
			$tabOuvrage[$index++]=$row;
		}
	}
	return  $tabOuvrage;
}

/*
 * recherche des ouvrages encore achetable.
 * Enter description here ...
 */
function return_nbrestantAchat($tyo, $ouv) {
	$tabOuvrage=array();
	
	$nbRestant=
	$requete = "select * " ;
	$requete .= " from ".CFG_PREFIXE_TABLE."ouvrage_emprunt ";
	$requete .= " where oem_id_tyo = $tyo ";
	$requete .= " and oem_id_oep = $oep ";
	$requete .= " order by oem_date_debut ";
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}
	else {
		while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
			
		}
	}
	return  $tabOuvrage;
}
?>