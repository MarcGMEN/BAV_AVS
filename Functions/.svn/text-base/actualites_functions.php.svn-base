<?php

/*
 * retourne un user pour un id
 */
function return_actus($dateValidite="", $idRub="") {
	$row=null;
	$tabReturn=array();
	$requete = "select *, rub_libelle, usr_nom ";
	$requete .= " from ".CFG_PREFIXE_TABLE."actus, ".CFG_PREFIXE_TABLE."rubrique, ".CFG_PREFIXE_TABLE."user ";
	$requete .= " where act_rub_id =rub_id " ;
	$requete .= " and act_usr_id =usr_id " ;
	$requete .= " and act_type= 'actu' " ;
	if (isset($idRub) && strlen(trim($idRub)) > 0) {
		$requete .= " and (rub_id = ".$idRub;
		$requete .= " or rub_id_rub = ".$idRub.")";
	}
	if (isset($dateValidite) || strlen(trim($dateValidite)) > 0 ){
		$requete .= " and (act_date_validite >= '".formateDateFRtoMYSQL($dateValidite)."' ";
		$requete .= " or act_date_validite is null )";
	}
	$requete .= "order by act_date desc, act_date_modification desc,  act_rub_id ";
	//echo $requete;
	if (!$resultat = mysql_query($requete)) {
		echo "erreur sur $requete ";
	}

	$i=0;
	while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
		$tabReturn[$row['act_id']] = $row;
	}

	return  $tabReturn;
}

/*
 * retourne un user pour un id
 */
function return_actusForUserModif($user, $id_rub) {
	global $membre_NIVEAU_MODIF_RUBRIQUE;
	$row=null;
	$tabReturn=array();
	$requete = "select *, rub_libelle, usr_nom ";
	$requete .= " from ".CFG_PREFIXE_TABLE."actus, ".CFG_PREFIXE_TABLE."rubrique, ".CFG_PREFIXE_TABLE."user ";
	$requete .= " where act_rub_id =rub_id " ;
	$requete .= " and act_usr_id =usr_id " ;
	$requete .= " and act_type= 'actu' " ;
	if (isset($id_rub) && strlen(trim($id_rub)) > 0) {
		$requete .= " and (rub_id = ".$id_rub;
		$requete .= " or rub_id_rub = ".$id_rub.")";
	}
	$requete .= " order by act_date desc, act_rub_id ";
	//echo $requete;
	$resultat = mysql_query($requete);

	$i=0;
	while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
		if (return_rubriqueForUserModif($row['act_rub_id'], $user)) {
			if ($user['tym_niveau'] > $membre_NIVEAU_MODIF_RUBRIQUE) {
				if ($user['usr_id'] ==  $row['act_usr_id']) {
					$tabReturn[$row['act_id']] = $row;
				}
			}
			else {
				$tabReturn[$row['act_id']] = $row;
			}
		}

	}

	return  $tabReturn;
}

function return_actusForUser($user, $id_rub) {
	global $membre_NIVEAU_MODIF_RUBRIQUE;
	$row=null;
	$tabReturn=array();
	$requete = "select *, rub_libelle, usr_nom ";
	$requete .= " from ".CFG_PREFIXE_TABLE."actus, ".CFG_PREFIXE_TABLE."rubrique, ".CFG_PREFIXE_TABLE."user ";
	$requete .= " where act_rub_id =rub_id " ;
	$requete .= " and act_usr_id =usr_id " ;
	$requete .= " and act_type= 'actu' " ;
	if (isset($id_rub) && strlen(trim($id_rub)) > 0) {
		$requete .= " and (rub_id = ".$id_rub;
		$requete .= " or rub_id_rub = ".$id_rub.")";
	}
	$requete .= "order by act_date, act_rub_id ";
	//echo $requete;
	$resultat = mysql_query($requete);

	$i=0;
	while ($row = mysql_fetch_array($resultat, MYSQL_ASSOC)) {
		if (return_rubriqueForUser($row['act_rub_id'], $user)) {
			$tabReturn[$row['act_id']] = $row;
		}
	}
	return  $tabReturn;
}


function return_actu($id) {
	$row=null;
	$requete = "select *, rub_libelle, usr_nom  ";
	$requete .= " from ".CFG_PREFIXE_TABLE."actus, ".CFG_PREFIXE_TABLE."rubrique, ".CFG_PREFIXE_TABLE."user ";
	$requete .= " where act_id =  ".$id;
	$requete .= " and act_rub_id =rub_id " ;
	$requete .= " and act_usr_id =usr_id " ;
	$requete .= " and act_type= 'actu' " ;
	//echo $requete;
	$resultat = mysql_query($requete);

	if (!$row = mysql_fetch_array($resultat, MYSQL_ASSOC) ) {
		echo "erreur sur $requete ".mysql_error()."<br/>";
	}

	return  $row;
}


function afficheActu($row, $FORMAT_ACTU,$TAILLE_RESUME_ACTU) {
	//print_r($row['act_texte']);
	$tabTexte=split("\n",$row['act_texte']);
	//print_r($tabTexte);
	$nbLigne=sizeof($tabTexte)+1;
	$zoom=false;
	if ($nbLigne > 0) {
		//echo $nbLigne*34; 
		if ($nbLigne*34 > $TAILLE_RESUME_ACTU) {
			$tail=$TAILLE_RESUME_ACTU;
			$zoom=true;
		}
		else
		{
			$tail=$nbLigne*34;
		}
	}
	?>

<?php//  echo $tail;?>
	<?php if ($FORMAT_ACTU == "reduit" && $zoom) {?>
<div style="height:<?=$tail?>px;overflow: hidden" id="resume_<?=$row['act_id']?>" >
<?php }?>
<?php if ($FORMAT_ACTU == "scrollbar"  && $zoom) {?>
	<div style="height:<?=$tail?>px;" class="actu_scroll">
	<?php }?>
	        <?=$row['act_texte']?>
		<?php if ($FORMAT_ACTU == "reduit"  && $zoom) {?>
	</div>
	<div id="detail_<?=$row['act_id']?>" class="link LINK_PRESENTATION"
		align="right"
		onclick="invertResumeActu('<?=$row['act_id']?>',<?=$tail?>)">Lire la suite</div>
		<?php } ?>
		<?php if ($FORMAT_ACTU == "scrollbar"  && $zoom) {?>
</div>
		<?php }?>

		<?php
}
?>