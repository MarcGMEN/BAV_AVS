<?

if (is_dir('Functions')) {
  require_once  'Functions/actualites_functions.php';
  require_once  'Functions/articles_functions.php';
} 
else if (is_dir('../Functions')) { 
//  require_once  '../Functions/actualites_functions.php';
//  require_once  '../Functions/articles_functions.php';
}

function cmpLastChangedDat($imgA, $imgB)
{
  $a=$imgA['date'];
  $b=$imgB['date'];
  if ($a == $b) {
    return 0;
  }
  return ($a > $b) ? -1 : 1;
}
//-- Fonction retournant la date de modification du dernier fichier
//-- modifier au sein du répertoire passé en paramètre.
function treeGetLastChangedDate($strRoot,$tabRepExclude=array(),$tabRepInclude=array(),$tabFileExclude=array())
{
  //-- Initialisation d'une variable locale pour stocker la dernière date
  //-- de modification.
  $dLastDate = 0;
  $dDate = 0;
  $tabModif=array();
  //-- Vérifier que le paramètre est un répertoire.
  if (is_dir($strRoot)) {
    //-- Lecture du contenu du répertoire passé en paramètre.
    $aDirectory = opendir($strRoot);
    //-- Parcours du contenu du répertoire.
    while ($strFile = readdir($aDirectory)) {
      if (($strFile != '.') && ($strFile != '..')) {
        
        //-- On récupère le chemin complet du fichier.
        $strFullFile = $strRoot.'/'.$strFile;
        //-- On traite le fichier...
        if (is_dir($strFullFile)) {
          $suite=true;
          foreach ($tabRepExclude as $val) {
            if (preg_match("[".$val."]",$strFile)) {
              //echo "pas de lecture pour $strFile";
              $suite=false;
              break;
            }
          }
          if ($suite) {
            //-- Si l'entrée est un répertoire, relancer la fonction sur cette entrée.
            $tabModif = array_merge($tabModif,treeGetLastChangedDate($strFullFile,$tabRepExclude,$tabRepInclude,$tabFileExclude));
          }
        } elseif (is_file($strFullFile)) {
          $suite=true;
          foreach ($tabFileExclude as $val) {
            if (preg_match("[".$val."]",$strFile)) {
              //echo "pas de lecture pour $strFile";
              $suite=false;
              break;
            }
          }
          foreach ($tabRepInclude as $val) {
            $suite=false;
            if (preg_match("[".$val."]",basename($strRoot))) {
              $suite=true;
              break;
            }
          }
          
          if ($suite) {
            //-- Si l'entrée est un fichier, on récupère sa date de modification.
            $dDate = filemtime($strFullFile);
            $tabModif[$dDate]['date']=$dDate ;
            $tabModif[$dDate]['name']=$strFullFile;
          }

        }
      }
    }
    //-- Fermeture du répertoire.
    closedir($aDirectory);
    //-- On retourne la date trouvée...
    return $tabModif;
  }
  return null;
}

function getLastModif($repNiveau="") {
  $tabRub=array();
  // format du tableau fin tabFin[index] => name, date, type, texte, url
  // recherche des photos
  $tabRepInclude=array("miniature");
  
  $tabFileExlude=array(".couverture","_icon.jpg",".album");
  
  $tabMAJPhotos=treeGetLastChangedDate($repNiveau."photos",array(),$tabRepInclude,$tabFileExlude);
  foreach ($tabMAJPhotos as $key => $val) {
    $tabMAJPhotos[$key]['type']="photo";

    $tabFile=explode("/",$val['name']);
    $module=$tabFile[0]; // photos
    $sep="";
    $texteAlb="";
    $tabTmp=explode("_",$tabFile[sizeof($tabFile)-3]);
    //print_r($tabTmp);
    $idRub=$tabTmp[1];
    if (!isset($tabRub[$idRub])) {
      $laRub = return_rubrique($idRub);
      $tabRub[$idRub]=$laRub;
    }
    else {
      $laRub=$tabRub[$idRub];
    }
    $texteAlb="photos dans l'album : ";
    if ($laRub['rub_libelle']) {
      $texteAlb.=$laRub['rub_libelle'];
    }
    else {
      //echo $val['name']."=> album ".substr(dirname(dirname($val['name'])),7)."<br/>";
      $nameAlbum=dirname(dirname(dirname($val['name'])))."/.album_$idRub";
      if (file_exists($nameAlbum)) {
      	$texteAlb.=file_get_contents($nameAlbum);
      }
      else {
      	$texteAlb=" photos ";
      }
    }
    $tabMAJPhotos[$key]['texte']=$texteAlb;
    $tabMAJPhotos[$key]['url']=makeURL_GET(array("mod" => $module,"rub" => 5,"option" => ""),"chemin=".substr(dirname(dirname($val['name'])),7));
  }
  
  // les presentations
  $tabRepInclude=array('presentation');
  $tabMAJuserfiles=treeGetLastChangedDate($repNiveau."userfiles",array(),$tabRepInclude,array());
  foreach ($tabMAJuserfiles as $key => $val) {
    $tabFile=explode("FOR",basename($val['name']));
    $module=$tabFile[0];
    $tabTmp=explode(".",$tabFile[1]);
    $idRub=$tabTmp[0];
    if ($idRub) {
      if (!isset($tabRub[$idRub])) {
        $laRub = return_rubrique($idRub);
        $tabRub[$idRub]=$laRub;
      }
      else {
        $laRub=$tabRub[$idRub];
      }
      $laRub = return_rubrique($idRub);
      $tabMAJuserfiles[$key]['type']="presentation";
      $tabMAJuserfiles[$key]['texte']=$laRub['rub_libelle'];
      $tabMAJuserfiles[$key]['url']=makeURL_GET(array("mod" => $module,"rub" => $idRub,"option" => ""),"");
    }
  }
  
  $tabLastActualite=array();
  $tabActusCote=return_actus(date('d/m/Y'));
  $module='actualites';
  $rubModule=return_rubriqueFromModule($module);
  foreach ($tabActusCote as $key => $val) {
    $tabLastActualite[$key]['name']=$val['act_sujet'];
    if ($val["act_date_modification"]!="") {
      $tabLastActualite[$key]['date']=dateMysqlInt($val["act_date_modification"],true);
    }
    else {
       $tabLastActualite[$key]['date']=dateMysqlInt($val["act_date"],true);
    }
    $tabLastActualite[$key]['type']="actualite";
    $tabLastActualite[$key]['texte']=$val['rub_libelle'];
    $tabLastActualite[$key]['url']=makeURL_GET(array("mod" => $module,"rub" => $rubModule['rub_id'],"option" => "&idAct=".$val['act_id']),"");
  }
  
  $tabLastArticle=array();
  $tabActircleCote=return_articles();
  $module='articles';
  $rubModule=return_rubriqueFromModule($module);
  foreach ($tabActircleCote as $key => $val) {
    $tabLastArticle[$key]['name']=$val['act_sujet'];
  if ($val["act_date_modification"]!="") {
      $tabLastArticle[$key]['date']=dateMysqlInt($val["act_date_modification"],true);
    }
    else {
       $tabLastArticle[$key]['date']=dateMysqlInt($val["act_date"],true);
    }
    $tabLastArticle[$key]['type']="article";
    $tabLastArticle[$key]['texte']=$val['rub_libelle'];
    $tabLastArticle[$key]['url']=makeURL_GET(array("mod" => $module,"rub" => $rubModule['rub_id'],"option" => "&idAct=".$val['act_id']),"");

  }
  $tabFin=array();
  if (is_array($tabMAJuserfiles)) {
    $tabFin=array_merge($tabFin,$tabMAJuserfiles);
  }
  
  if (is_array($tabMAJPhotos)) {
    $tabFin=array_merge($tabFin,$tabMAJPhotos);
  }
  
  if (is_array($tabLastActualite)) {
    $tabFin=array_merge($tabFin,$tabLastActualite);
  }
  
  if (is_array($tabLastArticle)) {
    $tabFin=array_merge($tabFin,$tabLastArticle);
  }
  
  usort($tabFin,"cmpLastChangedDat");

  return $tabFin;
}
?>