<?php
	$codeTyo = $config['ouvrage']['TYPE_OUVRAGE']['value'];

	if ($codeTyo) {
		$tabSearch1 = $_SESSION['tabRecherche'.$config['ouvrage']['TYPE_OUVRAGE']['value']];
		$tabParam = $_SESSION['tabParam'.$config['ouvrage']['TYPE_OUVRAGE']['value']];
		
		$theTyo = return_TypeOuvrage($codeTyo);
		$tabCso=return_AllChampsOuvrage($theTyo['tyo_id']);
		
		$allTyo=array();
	}
	else {
		$tabSearch1 = $_SESSION['tabRecherche'];
		$tabParam = $_SESSION['tabParam'];
		
		$theTyo = array();
		$tabCso=array();
		$allTyo=return_AllTypeOuvrage();
	}
	
	if (!$tabParam) {
	  $tabParam['typeSearch']="T";
	}
	echo "<pre>";
	print_r($tabParam);
	//print_r($tabSearch1);
	echo "</pre>";
	
?>
<script type="text/javascript">
<!--

function valideForm(laForm) {
		laForm.lAction.value="search";
		//Expression3 = new RegExp("^([a-zA-Z0-9_.-]+){1,}@([a-zA-Z0-9]+)([_\.-]+)([a-zA-Z0-9]+).([a-zA-Z]+){2,4}$","g");
	 	if (laForm.motsSearch.length == 0) {
		 	alert("Pas de mots de recherche ???");
			return false;
	 	}
	 	else if (ltrim(laForm.motsSearch.value).length < 3) {
		 	alert("Saisisez au moins 3 caractères.");
		 	return false;
	 	}
 		return true;
	}

	function resetFormSearch(laForm) {
		laForm.lAction.value="reset";
		laForm.submit();
	}
	//-->
</script>

<form action="actions/ouvrage_actions.php" method="POST" name=rechercheForm 
	name="search" method="POST" onsubmit="return valideForm(this);">
<input type="hidden" name="lAction" value="" />
<input type="hidden" name="tyo_id" value="<?=$theTyo['tyo_id']?>" />
<?makeURL_FORM(sizeof($_POST) > 0 ? $_POST : $_GET);?>
<table width="100%" border=0>
<tr>
	<td class="titrow" width='20%'>Recherche</td>
	<td  >
		<input type="text" size="30" maxlength="50" name="motsSearch" value="<?=$tabParam['motsSearch']?>" />
	</td>
	<td align="right" >
		<input type="radio" value="T" name="typeSearch" <?if ($tabParam['typeSearch'] == "T") echo "checked='checked'";?>/>Tous les mots
		<input type="radio" value="N" name="typeSearch" <?if ($tabParam['typeSearch'] == "N") echo "checked='checked'";?>/>N'importe quel mot
		<input type="radio" value="E" name="typeSearch" <?if ($tabParam['typeSearch'] == "E") echo "checked='checked'";?>/>Phrase exacte
	</td>
</tr>
<tr>
	<td class="titrow" >Filtrer</td>
	<td colspan='2'>
		<?php if (!$allTyo ) {?>
		<input type="checkbox" value="Titre" name="filtre[]" 
			<?php if (is_numeric(array_search('Titre',$tabParam['filtre[]']))) echo "checked='checked'"; ?>/>Titre
		<input type="checkbox" value="Resume" name="filtre[]" 
			<?php if (is_numeric(array_search('Resume',$tabParam['filtre[]']))) echo "checked='checked'"; ?>/>Résumé
		<?php foreach($tabCso as $val) {
			if ($val['cso_mode_saisie'] == "select") {?>
				<input type="checkbox" value="codeCso_<?=$val['cso_id']?>" name="filtre[]" 
				<?php if (is_numeric(array_search("codeCso_".$val['cso_id'],$tabParam['filtre[]']))) echo "checked='checked'"; ?>/><?=$val['cso_libelle']?>
			<?php }?>
		<?php }?>
		<?php }?>
		<?php foreach($allTyo as $val) {?>
			<input type="checkbox" value="codeTyo_<?=$val['tyo_id']?>" name="filtre[]" 
			<?php if (is_numeric(array_search("codeTyo_".$val['tyo_id'],$tabParam['filtre[]']))) echo "checked='checked'"; ?>
			/><?=$val['tyo_libelle_court']?>
		<?php }?>
	</td>
</tr>
<tr>
	<td colspan="3" align="center">
		<input  type="submit" value="Chercher" class="button"/>
		<input  type="button" value="Reset" class="button" onclick="resetFormSearch(this.form)" />
	</td>
</tr>
</table>
</form>

<?php if (sizeof($tabSearch1) > 0) {?>
	<table width='100%' cellpadding="3" cellspacing="1" border=0>
	<?php echo $key0;?>
	<?php foreach ($tabSearch1 as $key0 => $tabVal) {
      $type="";
        if ($type != $key0) {?>
        	<tr>
				<td colspan="20" class="TITRE_ACTU_COL"><?=$key0?></td>
        	</tr>
		<?php }
		$type=$key0;
		foreach ($tabVal as $key1 => $val1) {?>
		<tr class="tabl0" >
			<td title="Code" ><?=$key1?></td>
				
			<?foreach ($val1 as $key2 => $val2) {?>
				<td title="<?=$key2?>"
				 
				<?switch ($key2) {
					case 'Titre' : echo " width='100%'"; break;
					case 'Cote' : echo " width='5%'"; break;
				}
				?>
				><?=str_ireplace(" ", "&nbsp", trim($val2))?></td>
			<?php }?>
			<?php if ($DROIT_MODIF_RUB_USER) {?>
			 <td width="5%">
					<table width=100% class="maj">
                    	<tr>
	                        <td valign="top" align="center" width="5%" >
                            	<img src="Images/b_edit.png" border="0"
                            		alt="Modifier"  title="Modifier"
                            		onclick="x_return_ouvrage_ajax('<?=$key1?>','<?=$theTyo['tyo_id']?>',display_ouv_maj)"
                            		class="link" />
        	            </td>
        	            </tr>
        	           </table>
              </td>
       		<?php }?>
		</tr>
		<?}?>
	<?php }?>
  	</table>
<?php }
else {
	if (isset($tabParam['motsSearch']) && $tabParam['motsSearch'] != "") {?>
	<h3>Aucune occurrences trouvées.</h3>
	<?php }?>
<?}?>  
